# --- CONFIG SERVER ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: config-server
  template:
    metadata:
      labels:
        app: config-server
    spec:
      containers:
        - name: config-server
          image: insightvault-config-server:v1
          imagePullPolicy: Never # Force use of local image
          ports:
            - containerPort: 8888
          env:
            - name: SPRING_CLOUD_CONFIG_SERVER_GIT_URI
              value: "file:///config-repo"
          volumeMounts:
            - name: config-repo-vol
              mountPath: /config-repo
      volumes:
        - name: config-repo-vol
          hostPath:
            # Docker Desktop Windows syntax for U:\Microservices\insightvault\config-repo
            path: /run/desktop/mnt/host/u/Microservices/insightvault/config-repo
            type: Directory
---
apiVersion: v1
kind: Service
metadata:
  name: config-server
spec:
  selector:
    app: config-server
  ports:
    - protocol: TCP
      port: 8888
      targetPort: 8888
  type: ClusterIP

---
# --- DISCOVERY SERVICE (EUREKA) ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: eureka-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: eureka-server
  template:
    metadata:
      labels:
        app: eureka-server
    spec:
      containers:
        - name: eureka-server
          image: insightvault-eureka-server:v1
          imagePullPolicy: Never
          ports:
            - containerPort: 8761
          env:
            - name: SPRING_CONFIG_IMPORT
              value: "configserver:http://config-server:8888"
            - name: EUREKA_CLIENT_REGISTER_WITH_EUREKA
              value: "false"
            - name: EUREKA_CLIENT_FETCH_REGISTRY
              value: "false"
---
apiVersion: v1
kind: Service
metadata:
  name: eureka-server
spec:
  selector:
    app: eureka-server
  ports:
    - protocol: TCP
      port: 8761
      targetPort: 8761
  type: ClusterIP

---
# --- AUTH SERVICE ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
        - name: auth-service
          image: insightvault-auth-service:v1
          imagePullPolicy: Never
          ports:
            - containerPort: 8081
          env:
            - name: SPRING_CONFIG_IMPORT
              value: "configserver:http://config-server:8888"
            - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
              value: "http://eureka-server:8761/eureka/"
            - name: SPRING_DATASOURCE_URL
              value: "jdbc:mysql://mysql-db:3306/insight_auth_db"
            # ADDED CREDENTIALS
            - name: SPRING_DATASOURCE_USERNAME
              value: "root"
            - name: SPRING_DATASOURCE_PASSWORD
              value: "root"
            - name: JWT_KEYSTORE_PATH
              value: "/certs/jwt.p12"
            - name: EUREKA_INSTANCE_PREFER_IP_ADDRESS
              value: "true"
          volumeMounts:
            - name: certs-vol
              mountPath: /certs
      volumes:
        - name: certs-vol
          hostPath:
            # Path for U:\Microservices\securityCert
            path: /run/desktop/mnt/host/u/Microservices/securityCert
            type: Directory
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
spec:
  selector:
    app: auth-service
  ports:
    - protocol: TCP
      port: 8081
      targetPort: 8081
  type: ClusterIP

---
# --- DOCUMENT SERVICE ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: document-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: document-service
  template:
    metadata:
      labels:
        app: document-service
    spec:
      containers:
        - name: document-service
          image: insightvault-document-service:v1
          imagePullPolicy: Never
          ports:
            - containerPort: 8082
          env:
            - name: SPRING_CONFIG_IMPORT
              value: "configserver:http://config-server:8888"
            - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
              value: "http://eureka-server:8761/eureka/"
            - name: SPRING_DATASOURCE_URL
              value: "jdbc:mysql://mysql-db:3306/insight_doc_db"
            # ADDED CREDENTIALS
            - name: SPRING_DATASOURCE_USERNAME
              value: "root"
            - name: SPRING_DATASOURCE_PASSWORD
              value: "root"
            - name: SPRING_RABBITMQ_HOST
              value: "rabbitmq"
            - name: STORAGE_ENDPOINT
              value: "http://minio:9000"
            - name: STORAGE_PUBLIC_ENDPOINT
              value: "http://localhost:30000/minio"
            - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI
              value: "http://auth-service:8081/.well-known/jwks.json"
            - name: EUREKA_INSTANCE_PREFER_IP_ADDRESS
              value: "true"
            # Note: STORAGE_PUBLIC_ENDPOINT logic needs Ingress, skipping for internal testing or use NodePort later
---
apiVersion: v1
kind: Service
metadata:
  name: document-service
spec:
  selector:
    app: document-service
  ports:
    - protocol: TCP
      port: 8082
      targetPort: 8082
  type: ClusterIP

---
# --- AI PROCESSOR SERVICE ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ai-service
  template:
    metadata:
      labels:
        app: ai-service
    spec:
      containers:
        - name: ai-service
          image: insightvault-ai-service:v1
          imagePullPolicy: Never
          ports:
            - containerPort: 8083
          env:
            - name: SPRING_CONFIG_IMPORT
              value: "configserver:http://config-server:8888"
            - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
              value: "http://eureka-server:8761/eureka/"
            - name: SPRING_RABBITMQ_HOST
              value: "rabbitmq"
            - name: STORAGE_ENDPOINT
              value: "http://minio:9000"
            - name: DOCUMENT_SERVICE_URL
              value: "http://document-service:8082"
            - name: AUTH_SERVICE_URL
              value: "http://auth-service:8081"
            - name: EUREKA_INSTANCE_PREFER_IP_ADDRESS
              value: "true"
            # Add API Key if needed via Secret in production
            # - name: GOOGLE_API_KEY
            #   valueFrom:
            #     secretKeyRef:
            #       name: ai-secrets
            #       key: google-api-key
---
apiVersion: v1
kind: Service
metadata:
  name: ai-service
spec:
  selector:
    app: ai-service
  ports:
    - protocol: TCP
      port: 8083
      targetPort: 8083
  type: ClusterIP

---
# --- SEARCH SERVICE ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: search-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: search-service
  template:
    metadata:
      labels:
        app: search-service
    spec:
      containers:
        - name: search-service
          image: insightvault-search-service:v1
          imagePullPolicy: Never
          ports:
            - containerPort: 8084
          env:
            - name: SPRING_CONFIG_IMPORT
              value: "configserver:http://config-server:8888"
            - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
              value: "http://eureka-server:8761/eureka/"
            - name: SPRING_RABBITMQ_HOST
              value: "rabbitmq"
            - name: SPRING_ELASTICSEARCH_URIS
              value: "http://elasticsearch:9200"
            - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI
              value: "http://auth-service:8081/.well-known/jwks.json"
            - name: EUREKA_INSTANCE_PREFER_IP_ADDRESS
              value: "true"
---
apiVersion: v1
kind: Service
metadata:
  name: search-service
spec:
  selector:
    app: search-service
  ports:
    - protocol: TCP
      port: 8084
      targetPort: 8084
  type: ClusterIP

---
# --- API GATEWAY ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
        - name: api-gateway
          image: insightvault-gateway:v1
          imagePullPolicy: Never
          ports:
            - containerPort: 8765
          env:
            - name: SPRING_CONFIG_IMPORT
              value: "configserver:http://config-server:8888"
            - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
              value: "http://eureka-server:8761/eureka/"
            - name: EUREKA_INSTANCE_PREFER_IP_ADDRESS
              value: "true"
            - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI
              value: "http://auth-service:8081/.well-known/jwks.json"
---
# Expose Gateway to Localhost via NodePortxx
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
spec:
  selector:
    app: api-gateway
  ports:
    - protocol: TCP
      port: 8765
      targetPort: 8765
      nodePort: 30765 # Access via http://localhost:30765
  type: NodePort

---
# --- FRONTEND ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: frontend
          image: insightvault-frontend:v1
          imagePullPolicy: Never
          ports:
            - containerPort: 80
          env:
            # The React app needs to call the API Gateway from your browser
            # Since Gateway is exposed on NodePort 30765, we use that here.
            - name: VITE_API_BASE_URL
              value: "http://localhost:30765"
---
# Expose Frontend to Localhost via NodePort
apiVersion: v1
kind: Service
metadata:
  name: frontend
spec:
  selector:
    app: frontend
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
      nodePort: 30000 # Access via http://localhost:30000
  type: NodePort